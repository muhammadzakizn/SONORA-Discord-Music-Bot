# SONORA v3.9.1 - MFA Persistence & Returning User Flow

**Release Date:** 2025-12-14

## MFA Improvements

This update enhances the Multi-Factor Authentication system to persist TOTP secrets and provide seamless login for returning users.

### Changes

#### Backend - TOTP Persistence
- **TOTP Setup Route** - Now proxies to Bot API which stores encrypted secrets in database
- **TOTP Verify Route** - Supports both setup verification and login verification against stored secrets
- **Graceful Fallback** - Local verification when Bot API unavailable (with warning)

#### Frontend - Returning User Flow
- **MFA Method Detection** - OAuth callback passes `mfaMethods` array to frontend
- **Method Selection** - Returning users see verification options (Discord DM or Auth App)
- **TOTP Login Verification** - `verifyTOTP()` function verifies against stored database secret
- **No Re-setup Required** - Users with existing MFA can verify without scanning QR again

### Technical Details

- Next.js API routes (`/api/mfa/totp/setup`, `/api/mfa/totp/verify`) now use `BOT_API_URL` environment variable
- Login page `handleVerifyCode` updated to handle TOTP verification for `mfa-verify` mode
- OAuth callback correctly sets `authState: 'mfa_required'` with `mfaMethods` for existing users

### Files Modified
- `web/src/app/api/mfa/totp/setup/route.ts`
- `web/src/app/api/mfa/totp/verify/route.ts`
- `web/src/app/login/page.tsx`
