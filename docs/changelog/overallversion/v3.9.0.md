# SONORA v3.9.0 - Bank-Level Authentication System

**Release Date:** 2025-12-14

## ðŸ” Security Overhaul - Bank-Level Authentication

This major update introduces a comprehensive authentication system with enterprise-grade security features.

### New Features

#### Authentication Database (`database/auth_db_manager.py`)
- **AES-256-GCM Encryption** - All sensitive data (TOTP secrets, tokens) encrypted with authenticated encryption
- **Argon2id Password Hashing** - Winner of Password Hashing Competition, GPU-resistant, memory-hard
- **HMAC-SHA256** - Data integrity verification for all codes
- **Secure Random Generation** - Cryptographically secure tokens using Python's secrets module

#### Database Tables
- `auth_users` - User accounts with status tracking
- `mfa_methods` - Multi-factor authentication methods
- `passkey_credentials` - WebAuthn/FIDO2 credentials
- `backup_codes` - Recovery codes (10 per user)
- `trusted_devices` - Remember trusted devices for 30 days
- `verification_codes` - OTP for email/Discord verification
- `security_log` - Complete audit trail of all security events
- `sessions` - Active login sessions
- `rate_limits` - Brute force protection

#### Security Features
- Auto account lockout after 5 failed attempts (15 min cooldown)
- Rate limiting on all authentication endpoints
- IP and device fingerprint tracking
- Complete security audit logging

### OAuth Integration
- Discord OAuth callback now checks auth database
- New users automatically registered on first login
- Existing users verified against stored data
- Trusted device detection for seamless MFA bypass
- Flow parameters: `flow=setup` (new users), `flow=verify` (existing users)

### Discord DM Verification
- Send OTP codes via Discord bot DM
- `POST /api/auth/mfa/discord/send` - Send verification code
- `POST /api/auth/mfa/discord/verify` - Verify code
- `POST /api/auth/mfa/discord/setup` - Enable Discord MFA
- 5-minute code expiration with automatic cleanup

### Auth API Endpoints (`web/api/auth_api.py`)
- `POST /api/auth/user/check` - Check if Discord user exists
- `POST /api/auth/user/register` - Register new user
- `GET /api/auth/users` - List all users (admin)
- `GET /api/auth/user/:id` - Get user details
- `PUT /api/auth/user/:id/status` - Update user status
- `POST /api/auth/mfa/totp/setup` - Setup authenticator app
- `POST /api/auth/mfa/totp/verify-setup` - Verify TOTP and activate
- `POST /api/auth/mfa/totp/verify` - Verify TOTP during login
- `POST /api/auth/mfa/discord/send` - Send Discord DM code
- `POST /api/auth/mfa/discord/verify` - Verify Discord DM code
- `POST /api/auth/mfa/backup-codes/generate` - Generate backup codes
- `POST /api/auth/mfa/backup-codes/verify` - Use backup code
- `GET /api/auth/trusted-devices` - List trusted devices
- `POST /api/auth/trusted-devices` - Add trusted device
- `DELETE /api/auth/trusted-devices/:id` - Remove device
- `GET /api/auth/security-log` - Get security audit log
- `GET /api/auth/login-history` - User's login history

### Frontend Auth Client (`web/src/lib/auth-api.ts`)
- TypeScript client for all auth API endpoints
- Full type definitions for responses
- Error handling and fallbacks

### Login Page Updates (`web/src/app/login/page.tsx`)
- New login modes: `mfa-setup`, `backup-codes`
- QR code display for TOTP setup
- Manual secret entry option
- Backup codes display with copy/download
- Trust device checkbox
- Seamless slide animations between states
- OAuth flow detection and automatic MFA routing

### Developer Dashboard - Auth Users Page (`/developer/auth-users`)
- View all authenticated users
- Filter by status (active, pending, suspended, banned)
- Search by username, Discord ID, or email
- View user's MFA methods
- View user's security log
- Update user status (suspend, ban, activate)

### Dependencies Added
- `cryptography>=41.0.0` - AES-256-GCM, key derivation
- `argon2-cffi>=23.1.0` - Argon2id password hashing
- `pyotp>=2.9.0` - TOTP/HOTP generation
- `webauthn>=2.0.0` - WebAuthn/FIDO2 support
- `aiosmtplib>=3.0.0` - Async SMTP for email OTP

---

## Migration Notes

1. Install new dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Set master encryption key in `.env`:
   ```env
   SONORA_MASTER_KEY=your-64-char-hex-key
   ```

3. Auth database will be created automatically on first run.


---

## Security Recommendations

- **Always set `SONORA_MASTER_KEY`** in production
- Keep `auth.db` secure and backed up
- Monitor `security_log` table for suspicious activity
- Enable at least 2 MFA methods for admin accounts
