# v3.9.2 - Passkey MFA Implementation

**Release Date:** 2025-12-14

## Passkey (WebAuthn) MFA

### Backend - Database Functions
- `store_passkey_challenge()` - Store challenge for verification
- `get_passkey_challenge()` - Retrieve stored challenge
- `clear_passkey_challenge()` - Clean up after use
- `setup_passkey()` - Store encrypted credential in database
- `get_passkey_credentials()` - Get all passkeys for user
- `get_passkey_by_credential_id()` - Lookup by credential ID
- `update_passkey_counter()` - Update counter after auth (replay protection)
- `delete_passkey()` - Remove passkey

### Backend - Bot API Endpoints
- `POST /api/auth/mfa/passkey/register` - Generate registration options
- `POST /api/auth/mfa/passkey/register/complete` - Verify and store credential
- `POST /api/auth/mfa/passkey/authenticate` - Generate auth options
- `POST /api/auth/mfa/passkey/authenticate/complete` - Verify authentication

### Frontend - Next.js Routes
- All 4 passkey routes proxy to Bot API for database persistence
- Removed in-memory storage (credentials now persist across restarts)

### Frontend - Login Page
- Added `handlePasskeySetup` for new user registration
- Added `handlePasskeyVerify` for returning user authentication
- Passkey support detection via `browserSupportsWebAuthn()`
- Sets `sonora-mfa-verified` cookie on success

### Files Modified
- `database/auth_db_manager.py`
- `web/api/auth_api.py`
- `web/src/app/api/mfa/passkey/register/route.ts`
- `web/src/app/api/mfa/passkey/register/complete/route.ts`
- `web/src/app/api/mfa/passkey/authenticate/route.ts`
- `web/src/app/api/mfa/passkey/authenticate/complete/route.ts`
- `web/src/app/login/page.tsx`
