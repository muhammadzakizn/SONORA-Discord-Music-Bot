# SONORA v3.7.0 - Multi-Factor Authentication

**Release Date:** 2024-12-13

## Summary
Implemented bank-level Multi-Factor Authentication (MFA) for Admin and Developer dashboards with three authentication methods.

---

## Authentication Methods

### 1. Passkey (WebAuthn) - Default
- Fingerprint/Face ID biometric
- Platform authenticator support
- Challenge-response security

### 2. Authenticator App (TOTP)
- Google Authenticator compatible
- Authy compatible
- QR code setup
- 6-digit time-based codes

### 3. OTP (One-Time Password)
- Discord DM (existing)
- Email (new)
- Rate-limited requests

---

## Developer Dashboard Integration (Enhanced)

### Console
- Real-time logs via `/api/admin/logs`
- Auto-polling every 3 seconds

### Messaging  
- Broadcast via `/api/admin/broadcast`
- **NEW:** Server/channel dropdown selection
- Shows connected servers count

### Bot Controls
- Shutdown via `/api/admin/shutdown`
- **NEW:** `/api/admin/bot/restart` - Restart bot gracefully
- **NEW:** `/api/admin/bot/pause` - Pause all playback
- **NEW:** `/api/admin/bot/resume` - Resume all playback
- **NEW:** `/api/admin/maintenance` - Toggle maintenance mode

### Other
- Profile Settings link in developer dropdown

---

## Files Created

### MFA Page
- `web/src/app/mfa/page.tsx`

### API Endpoints
- `web/src/app/api/mfa/passkey/register/route.ts`
- `web/src/app/api/mfa/passkey/register/complete/route.ts`
- `web/src/app/api/mfa/passkey/authenticate/route.ts`
- `web/src/app/api/mfa/passkey/authenticate/complete/route.ts`
- `web/src/app/api/mfa/totp/setup/route.ts`
- `web/src/app/api/mfa/totp/verify/route.ts`

### Modified
- `web/src/app/api/verify/send/route.ts` - Added email method + rate limiting
- `web/src/app/developer/layout.tsx` - Added Profile Settings link
- `web/src/app/developer/messaging/page.tsx` - Server/channel dropdown
- `web/src/app/developer/controls/page.tsx` - Full API integration
- `web/api/app.py` - New bot control endpoints

---

## Dependencies Added
- @simplewebauthn/browser
- @simplewebauthn/server
- otplib
- qrcode

---

## Server Management Enhancement (2024-12-13)

### Developer Dashboard - Server Management

#### New Features
- **Real-time Server List** - Fetch servers from actual SONORA bot invites
- **Server Detail Modal** - Comprehensive view with tabs:
  - Overview: Current playing track, voice channel, stats
  - Channels: Enable/disable channels for bot commands
  - Members: View and ban users directly
  - Controls: Stop audio, clear queue, kick bot

#### Disabled Channels
- Disable specific text channels in servers
- Bot shows warning + support link when command used in disabled channel
- Toggle enable/disable from dashboard

#### User Ban from Server Context
- Ban users directly from server member list
- Auto-adds to global ban list
- Duration options: permanent, 1/7/30/90 days

### Backend API Endpoints (app.py)
- `/api/admin/guild/<guild_id>/details` - Full guild info
- `/api/admin/guild/<guild_id>/stop-audio` - Stop audio + clear queue
- `/api/admin/guild/<guild_id>/clear-queue` - Clear queue only
- `/api/admin/guild/<guild_id>/kick` - Disconnect bot from voice
- `/api/admin/disabled-channels` - List all disabled channels
- `/api/admin/guild/<guild_id>/channels/<channel_id>/disable` - Toggle channel
- `/api/admin/guild/<guild_id>/ban-user/<user_id>` - Ban user from server

### Files Modified
- `web/api/app.py` - New server management endpoints
- `web/src/app/developer/servers/page.tsx` - Complete rewrite with modal

---

## Server Management Fixes (2024-12-13)

### Bug Fixes
- **Voice Channels** - Channels tab now shows text, voice, and stage channels (not just text)
- **Dropdown Menu** - Three dots button now works with Stop Audio, Clear Queue, Kick Bot options
- **Queue Display** - Controls tab now shows up to 20 queue items with position, title, artist, duration

### Ban Enforcement (Bot-Side)
- Banned users now blocked from using ANY bot command
- Shows warning embed with ban reason + support button
- Disabled channels now block commands with warning embed

### Backend Changes (app.py)
- `/api/admin/guild/<id>/details` now returns combined `channels` array with type indicator
- Queue items included in response (`queueItems` array)
- Ban reason included in member data

### Files Modified
- `core/bot.py` - Added banned user + disabled channel checks in command handler
- `web/api/app.py` - Updated guild details endpoint with combined channels
- `web/src/app/developer/servers/page.tsx` - Fixed dropdown, added queue display

---

## Leave Server & Server Ban Feature (2024-12-13)

### "Kick Bot" → "Leave Server"
- Replaced "Kick Bot" (voice disconnect only) with "Leave Server" (full leave)
- New Leave Server modal with:
  - **Reason input** - Reason displayed in goodbye message
  - **Channel dropdown** - Select target channel(s) for goodbye message
  - **Ban checkbox** - Ban server so bot auto-leaves if re-invited

### Bot-Side Banned Server Enforcement
- On guild join, checks if server is in `_banned_servers`
- If banned → DM owner with reason + support link → auto-leave server
- Prevents banned servers from using bot even if re-invited

### Backend Changes (app.py)
- New endpoint: `POST /api/admin/guild/<id>/leave`
  - Params: `reason`, `target_channel`, `ban_server`
  - Sends goodbye message with support button before leaving
  - Adds to `_banned_servers` if ban option checked
- Updated `api_admin_guild_details` to include `sendableChannels`

### Files Modified
- `core/bot.py` - Added banned server check on `on_guild_join`
- `web/api/app.py` - New leave endpoint with ban option
- `web/src/app/developer/servers/page.tsx` - Leave Server modal UI

---

## Users & Servers Page Update (2024-12-13)

### Page Renamed
- "User Management" → "Users & Servers"
- Main tabs to switch between Users and Servers views

### Banned Servers Tab
- Shows all servers banned via "Leave Server" feature
- Displays: Server name, ban reason, banned date, banned by
- Search functionality for banned servers
- Links to bans API endpoint

### Files Modified
- `web/src/app/developer/users/page.tsx` - Complete UI overhaul with tabs
