# SONORA v3.8.0 - Component Status Dialogs & Cache Management

**Release Date:** 2024-12-13

## Summary
Added clickable component status cards in the Developer Monitoring page with detailed dialogs, and a comprehensive Cache Management dialog for the Cache System component.

---

## Component Status Dialogs

### All Component Cards Now Clickable
- **Discord Bot** - Shows bot description, status, latency, guild/user count
- **Database (SQLite)** - Shows database connection status and info
- **Web API** - Shows API server status and port
- **Voice Engine** - Shows voice connection stats
- **Spotify API** - Shows Spotify credential status
- **YouTube API** - Shows yt-dlp version and status
- **Apple Music** - Shows cookie authentication status

### Click on any component card to see:
- Component description (in Indonesian)
- Current status (Online/Warning/Offline)
- Latency metrics
- Features & Functions list
- Issues to fix (if any errors)

---

## Cache Management Dialog

### Special dialog for Cache System card with:

#### Cache Types Displayed
1. **Audio Cache** - Downloaded .opus/.m4a files (~/downloads)
2. **Artwork Cache** - Album art and track images (~/cache/artwork)
3. **Python Cache** - __pycache__ bytecode files
4. **Next.js Cache** - Build cache and optimized assets
5. **In-Memory Cache** - Lyrics, metadata, track info (RAM)

#### Features
- Real-time size and file count for each cache type
- Individual delete buttons per cache type
- "Delete All Cache" button
- Two tabs: Cache Files | Auto-Cleanup Settings

#### Auto-Cleanup Settings
- **Storage Threshold** - Delete old cache when exceeding limit (default: 2GB)
- **Age Threshold** - Delete files not used for X days (default: 3 days)
- **Warning Notification** - Alert developer when cache reaches threshold
- **Auto-Cleanup Toggle** - Enable/disable automatic cleanup

---

## New Backend API Endpoints (Flask)

### Cache Management
- `GET /api/admin/cache/stats` - Detailed stats for all cache types
- `POST /api/admin/cache/clear/<type>` - Clear specific cache (audio/artwork/pycache/nextjs/memory/all)
- `GET/POST /api/admin/cache/settings` - Get or update auto-cleanup settings

### Component Details
- `GET /api/developer/component/<name>` - Get detailed info about specific component

---

## Files Created/Modified

### New Files
- `web/src/components/developer/ComponentStatusDialog.tsx`
- `web/src/components/developer/CacheManagementDialog.tsx`
- `config/cache_settings.json`

### Modified Files
- `web/src/app/developer/monitoring/page.tsx` - Added clickable cards and dialog integration
- `web/api/app.py` - Added 4 new cache management endpoints

---

## Technical Details

- Cache settings stored in `config/cache_settings.json`
- Settings persist across bot restarts
- Live update to audio cache manager when settings change
- Component dialogs follow existing UpdateDialog.tsx pattern
- Framer Motion animations for smooth dialog transitions

---

## Bot Controls Improvements

### Seamless Dashboard Restart
- Restart via dashboard no longer shows "Found existing instance" warning
- Creates `.dashboard_restart` flag file before restart
- `main.py` detects flag and skips verbose instance check warnings
- Only shows "Dashboard restart detected, taking over..." message

### Maintenance Mode Navigation
- Maintenance Mode button now navigates to `/developer/maintenance` page
- Added `ExternalLink` icon to indicate navigation
- Changed from confirmation dialog to direct navigation

---

## Comprehensive Maintenance Mode System

### Discord Bot Integration
- All commands rejected during maintenance with detailed embed:
  - Shows reason, progress percentage, current stage
  - Visual progress bar using block characters
  - Time elapsed since maintenance started
- Status Page link button (sonora.muhammadzakizn.com/status)
- Changelog link button (bit.ly/changeLog)
- Message ID tracking per channel to delete old notifications

### Web Dashboard Maintenance Page
- Connected to backend API instead of local state
- Real-time progress updates (auto-refresh every 5 seconds)
- Stage selector with 6 stages:
  - Starting Maintenance
  - Creating Backups
  - Applying Updates
  - Testing Systems
  - Finalizing Changes
  - Completing
- **Changelog Items Editor**:
  - Add items during maintenance
  - Delete individual items
  - Auto-append to changelog file on completion

### Status Page Integration
- Maintenance banner displayed when maintenance active
- Shows progress bar with percentage
- Stage label and reason
- Started time display

### New API Endpoints
- `GET /api/admin/maintenance/status` - Full maintenance status
- `POST /api/admin/maintenance/activate` - Start maintenance
- `POST /api/admin/maintenance/progress` - Update progress/stage
- `POST /api/admin/maintenance/complete` - Complete with changelog
- `POST/DELETE /api/admin/maintenance/message-id` - Track Discord messages
- `POST/DELETE /api/admin/maintenance/changelog-item` - Manage changelog items

### Persistent State
- `config/maintenance_state.json` stores state across restarts
- Includes: enabled, reason, progress, stage, message_ids, changelog_items, history

### Files Created/Modified
- `config/maintenance_state.json` - Persistent maintenance state
- `web/api/app.py` - 8 new maintenance endpoints
- `core/bot.py` - Enhanced maintenance check with message tracking
- `web/src/app/developer/maintenance/page.tsx` - Complete rewrite with API
- `web/src/app/status/page.tsx` - Maintenance banner and progress display
