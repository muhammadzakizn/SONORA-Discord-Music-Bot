<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SONORA - Admin Panel</title>
    
    <!-- v3.3.0 Styles -->
    <link rel="stylesheet" href="/static/css/maroon-theme.css">
    <link rel="stylesheet" href="/static/css/glass.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/taskbar-fix.css">
    
    <style>
        body { margin: 0; padding: 0 0 100px 0; min-height: 100vh; }
        .admin-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .control-card button { width: 100%; padding: 1.5rem; border: none; background: none; cursor: pointer; text-align: left; }
        .hover-bg:hover { background: rgba(128, 0, 32, 0.1); }
        .glass-input { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 8px; 
            color: var(--text-primary);
            font-family: inherit;
        }
        .glass-input:focus {
            outline: none;
            border-color: var(--maroon-primary);
            background: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="dark-mode page-transition">
    
    <div class="netflix-loader" id="page-loader">
        <div class="loading-bar" style="width: 100%;"></div>
        <div class="netflix-logo">üéµ SONORA</div>
    </div>
    
    <div class="admin-container">
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h1 class="gradient-maroon-text" style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">
                üéµ SONORA Admin Panel
            </h1>
            <p style="color: var(--text-secondary);">
                Manage your music bot - Control, broadcast, and monitor
            </p>
        </div>
        
        <!-- System Health Stats -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üíª System Health</h2>
            <div class="control-grid">
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üñ•Ô∏è</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">CPU Usage</div>
                        <div id="cpu-usage" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">--%</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíæ</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Memory Usage</div>
                        <div id="memory-usage" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">-- MB</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è±Ô∏è</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Uptime</div>
                        <div id="bot-uptime" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">--:--:--</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì°</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Latency</div>
                        <div id="bot-latency" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">-- ms</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíø</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Database Size</div>
                        <div id="db-size" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">-- MB</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Cache Size</div>
                        <div id="cache-size" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">-- MB</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot Modules -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üîß Bot Modules</h2>
            <div id="modules-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">Loading modules...</div>
            </div>
        </div>
        
        <!-- Analytics Stats -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üìä Command Statistics</h2>
            <div id="command-stats" style="max-height: 400px; overflow-y: auto;">
                <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">Loading command stats...</div>
            </div>
        </div>
        
        <!-- Platform Stats -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üéµ Platform Statistics</h2>
            <div class="control-grid">
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üü¢</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Spotify</div>
                        <div id="spotify-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì∫</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">YouTube</div>
                        <div id="youtube-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üçé</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Apple Music</div>
                        <div id="apple-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Play Method Stats -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üéØ Play Method Statistics</h2>
            <div class="control-grid">
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîó</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Single Track</div>
                        <div id="single-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìã</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Playlist</div>
                        <div id="playlist-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üíø</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Album</div>
                        <div id="album-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
                
                <div class="glass-card hover-lift">
                    <div style="padding: 1.5rem; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîç</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Search</div>
                        <div id="search-count" style="font-size: 1.75rem; font-weight: 700; color: var(--maroon-primary);">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Tracks -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üéµ Most Requested Tracks</h2>
            <div id="top-tracks" style="max-height: 400px; overflow-y: auto;">
                <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">Loading top tracks...</div>
            </div>
        </div>
        
        <!-- Maintenance Mode -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üîß Maintenance Mode</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Status:</div>
                        <select id="maintenance-toggle" class="glass-input" style="width: 100%; padding: 0.75rem;">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </label>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Maintenance Reason:</label>
                    <textarea id="maintenance-reason" class="glass-input" style="width: 100%; min-height: 100px; padding: 0.75rem; resize: vertical;" placeholder="Enter reason for maintenance (will be shown to users)">Server maintenance in progress. Please try again later.</textarea>
                </div>
                
                <button onclick="updateMaintenance()" class="btn-maroon" style="padding: 1rem; font-weight: 600;">
                    üíæ Update Maintenance Mode
                </button>
                
                <div id="maintenance-status" style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; display: none;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Current Status:</div>
                    <div id="maintenance-status-text" style="color: var(--text-secondary);"></div>
                </div>
            </div>
        </div>
        
        <!-- Broadcasting -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üì¢ Broadcast Message</h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Broadcast Message:</label>
                    <textarea id="broadcast-message" class="glass-input" style="width: 100%; min-height: 120px; padding: 0.75rem; resize: vertical;" placeholder="Enter your broadcast message here..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Mention Type:</label>
                        <select id="mention-type" class="glass-input" style="width: 100%; padding: 0.75rem;">
                            <option value="none">No Mention</option>
                            <option value="everyone">@everyone</option>
                            <option value="here">@here</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Target:</label>
                        <select id="broadcast-target" class="glass-input" style="width: 100%; padding: 0.75rem;" onchange="updateBroadcastTarget()">
                            <option value="all">All Servers & Channels</option>
                            <option value="servers">Selected Servers (First Channel)</option>
                            <option value="channels">Selected Channels</option>
                        </select>
                    </div>
                </div>
                
                <div id="server-selection" style="display: none;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Select Servers:</label>
                    <div id="servers-list" class="glass-card" style="padding: 1rem; max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--text-secondary);">Loading servers...</div>
                    </div>
                </div>
                
                <div id="channel-selection" style="display: none;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Select Channels:</label>
                    <div id="channels-list" class="glass-card" style="padding: 1rem; max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--text-secondary);">Loading channels...</div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: #ffc107;">‚ö†Ô∏è Warning:</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        ‚Ä¢ Bot will check permissions before sending<br>
                        ‚Ä¢ Channels without send_messages permission will be skipped<br>
                        ‚Ä¢ @everyone/@here requires mention_everyone permission<br>
                        ‚Ä¢ Large broadcasts may take time (rate limited)
                    </div>
                </div>
                
                <button onclick="sendBroadcast()" class="btn-maroon" style="padding: 1rem; font-weight: 600;">
                    üì¢ Send Broadcast
                </button>
                
                <div id="broadcast-result" style="display: none; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Broadcast Result:</div>
                    <div id="broadcast-result-content" style="font-size: 0.875rem;"></div>
                </div>
            </div>
        </div>
        
        <!-- Console Logs -->
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üìù Console Logs</h2>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button onclick="filterLogs('all')" class="btn-maroon" style="padding: 0.5rem 1rem;">All</button>
                <button onclick="filterLogs('error')" class="btn-maroon" style="padding: 0.5rem 1rem; background: #dc3545;">Errors</button>
                <button onclick="filterLogs('warning')" class="btn-maroon" style="padding: 0.5rem 1rem; background: #ffc107;">Warnings</button>
                <button onclick="filterLogs('info')" class="btn-maroon" style="padding: 0.5rem 1rem; background: #17a2b8;">Info</button>
            </div>
            <div id="console-logs" style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1rem; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                <div style="color: var(--text-secondary);">Loading logs...</div>
            </div>
        </div>
        
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 class="accent-maroon" style="margin-bottom: 1.5rem; font-size: 1.5rem;">üéÆ Bot Controls</h2>
            <div class="control-grid">
                <div class="glass-card control-card hover-lift">
                    <button onclick="pauseAll()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚è∏Ô∏è</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">Pause All</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Pause playback in all servers</div>
                    </button>
                </div>
                
                <div class="glass-card control-card hover-lift">
                    <button onclick="resumeAll()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚ñ∂Ô∏è</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">Resume All</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Resume playback in all servers</div>
                    </button>
                </div>
                
                <div class="glass-card control-card hover-lift">
                    <button onclick="stopAll()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚èπÔ∏è</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">Stop All</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Disconnect from all voice channels</div>
                    </button>
                </div>
                
                <div class="glass-card control-card hover-lift">
                    <button onclick="clearCache()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üóëÔ∏è</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">Clear Cache</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Delete all cached downloads</div>
                    </button>
                </div>
                
                <div class="glass-card control-card hover-lift">
                    <button onclick="restartBot()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîÑ</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">Restart Bot</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Restart bot process</div>
                    </button>
                </div>
                
                <div class="glass-card control-card hover-lift" style="border: 2px solid rgba(220, 53, 69, 0.3);">
                    <button onclick="shutdownBot()" class="ripple">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üî¥</div>
                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; color: #DC3545;">Shutdown</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Stop bot completely</div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="taskbar-container"></div>
    
    <script>
        window.isAdmin = true;
        window.isAuthenticated = true;
    </script>
    <script src="/static/js/pwa.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/taskbar-working.js"></script>
    <script src="/static/js/admin-controls.js"></script>
    
    <script>
        let currentLogFilter = 'all';
        
        function pauseAll() { if (window.adminControls) adminControls.pauseAll(); }
        function resumeAll() { if (window.adminControls) adminControls.resumeAll(); }
        function stopAll() { if (window.adminControls) adminControls.stopAll(); }
        function clearCache() { if (window.adminControls) adminControls.clearCache(); }
        function restartBot() { if (window.adminControls) adminControls.restartBot(); }
        function shutdownBot() { if (window.adminControls) adminControls.shutdownBot(); }
        
        function filterLogs(type) {
            currentLogFilter = type;
            loadLogs();
        }
        
        // Maintenance Mode Functions
        async function updateMaintenance() {
            const enabled = document.getElementById('maintenance-toggle').value === 'true';
            const reason = document.getElementById('maintenance-reason').value.trim();
            
            if (enabled && !reason) {
                alert('Please enter a maintenance reason!');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/maintenance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable: enabled, reason: reason })
                });
                
                const result = await response.json();
                
                const statusDiv = document.getElementById('maintenance-status');
                const statusText = document.getElementById('maintenance-status-text');
                
                if (result.success) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
                    statusDiv.style.border = '1px solid rgba(40, 167, 69, 0.5)';
                    statusText.innerHTML = `
                        ‚úÖ ${result.message}<br>
                        Status: <strong>${enabled ? 'ENABLED' : 'DISABLED'}</strong><br>
                        ${enabled ? 'Reason: ' + reason : ''}
                    `;
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = 'rgba(220, 53, 69, 0.2)';
                    statusDiv.style.border = '1px solid rgba(220, 53, 69, 0.5)';
                    statusText.textContent = '‚ùå ' + (result.error || 'Failed to update maintenance mode');
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
                
            } catch (error) {
                console.error('Maintenance update error:', error);
                alert('Failed to update maintenance mode: ' + error.message);
            }
        }
        
        // Broadcasting Functions
        async function loadServersAndChannels() {
            try {
                const response = await fetch('/api/admin/guilds/channels');
                const data = await response.json();
                
                // Calculate totals
                let totalChannels = 0;
                let channelsWithSendPermission = 0;
                let channelsWithMentionPermission = 0;
                
                data.forEach(guild => {
                    guild.channels.forEach(channel => {
                        totalChannels++;
                        if (channel.permissions.send_messages) {
                            channelsWithSendPermission++;
                            if (channel.permissions.mention_everyone) {
                                channelsWithMentionPermission++;
                            }
                        }
                    });
                });
                
                // Update broadcast info
                const broadcastTarget = document.getElementById('broadcast-target');
                if (broadcastTarget && broadcastTarget.options[0]) {
                    broadcastTarget.options[0].text = `All Servers & Channels (${data.length} servers, ${totalChannels} channels)`;
                }
                
                // Load servers
                const serversList = document.getElementById('servers-list');
                serversList.innerHTML = data.map(guild => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 8px;" class="hover-bg">
                        <input type="checkbox" class="server-checkbox" value="${guild.id}" onchange="updateChannelsList()">
                        <span style="flex: 1;">${guild.name}</span>
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">${guild.channels.length} channels</span>
                    </label>
                `).join('');
                
                // Load all channels
                const channelsList = document.getElementById('channels-list');
                channelsList.innerHTML = data.map(guild => `
                    <div style="margin-bottom: 1rem; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px;">
                        <div style="font-weight: 700; margin-bottom: 0.75rem; color: var(--maroon-primary); font-size: 1.1rem;">
                            üìÅ ${guild.name}
                        </div>
                        ${guild.channels.map(channel => {
                            const canSend = channel.permissions.send_messages;
                            const canMention = channel.permissions.mention_everyone;
                            
                            let statusIcon = '‚úÖ';
                            let statusText = 'Can send';
                            let statusColor = '#28a745';
                            
                            if (!canSend) {
                                statusIcon = 'üö´';
                                statusText = 'Cannot send messages';
                                statusColor = '#dc3545';
                            } else if (!canMention) {
                                statusIcon = '‚ö†Ô∏è';
                                statusText = 'Cannot mention @everyone/@here';
                                statusColor = '#ffc107';
                            }
                            
                            return `
                                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: ${canSend ? 'pointer' : 'not-allowed'}; opacity: ${canSend ? '1' : '0.6'}; border-radius: 8px; margin-bottom: 0.5rem; background: rgba(255,255,255,0.03); border: 1px solid ${canSend ? 'rgba(40,167,69,0.3)' : 'rgba(220,53,69,0.3)'};" class="${canSend ? 'hover-bg' : ''}">
                                    <input type="checkbox" class="channel-checkbox" value="${channel.id}" ${canSend ? '' : 'disabled'} style="width: 18px; height: 18px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-primary);">#${channel.name}</div>
                                        <div style="font-size: 0.75rem; color: ${statusColor}; margin-top: 0.25rem;">
                                            ${statusIcon} ${statusText}
                                        </div>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load servers/channels:', error);
            }
        }
        
        function updateBroadcastTarget() {
            const target = document.getElementById('broadcast-target').value;
            document.getElementById('server-selection').style.display = target === 'servers' ? 'block' : 'none';
            document.getElementById('channel-selection').style.display = target === 'channels' ? 'block' : 'none';
        }
        
        function updateChannelsList() {
            // When servers are selected, update channels list to show only those servers
            const selectedServers = Array.from(document.querySelectorAll('.server-checkbox:checked')).map(cb => cb.value);
            const channelGroups = document.querySelectorAll('#channels-list > div');
            
            channelGroups.forEach(group => {
                const serverId = group.querySelector('label input')?.value?.split('-')[0]; // Get server ID from first channel
                // Show/hide based on selection (or show all if none selected)
                group.style.display = selectedServers.length === 0 || selectedServers.includes(serverId) ? 'block' : 'none';
            });
        }
        
        async function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            const mentionType = document.getElementById('mention-type').value;
            const target = document.getElementById('broadcast-target').value;
            
            if (!message) {
                alert('Please enter a broadcast message!');
                return;
            }
            
            if (!confirm('Are you sure you want to send this broadcast?\n\nThis will send the message to selected channels.')) {
                return;
            }
            
            const resultDiv = document.getElementById('broadcast-result');
            const resultContent = document.getElementById('broadcast-result-content');
            
            resultDiv.style.display = 'block';
            resultContent.innerHTML = '<div style="color: var(--text-secondary);">üì° Sending broadcast... Please wait...</div>';
            
            try {
                let requestData = {
                    message: message,
                    mention_type: mentionType,
                    all_channels: target === 'all'
                };
                
                if (target === 'servers') {
                    const selectedServers = Array.from(document.querySelectorAll('.server-checkbox:checked')).map(cb => cb.value);
                    if (selectedServers.length === 0) {
                        alert('Please select at least one server!');
                        return;
                    }
                    requestData.guild_ids = selectedServers;
                } else if (target === 'channels') {
                    const selectedChannels = Array.from(document.querySelectorAll('.channel-checkbox:checked')).map(cb => cb.value);
                    if (selectedChannels.length === 0) {
                        alert('Please select at least one channel!');
                        return;
                    }
                    requestData.channel_ids = selectedChannels;
                }
                
                const response = await fetch('/api/admin/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultContent.innerHTML = `
                        <div style="color: #28a745; margin-bottom: 1rem;">
                            ‚úÖ <strong>Broadcast Successful!</strong><br>
                            Sent: ${result.sent} messages<br>
                            Failed: ${result.failed} messages<br>
                            Total Servers: ${result.total_guilds}
                        </div>
                        ${result.results && result.results.length > 0 ? `
                            <div style="font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Detailed Results:</div>
                                ${result.results.map(r => `
                                    <div style="margin-bottom: 0.25rem; color: ${r.status === 'success' ? '#28a745' : '#dc3545'};">
                                        ${r.status === 'success' ? '‚úÖ' : '‚ùå'} ${r.guild} ‚Üí #${r.channel}
                                        ${r.reason ? `<span style="opacity: 0.7;"> (${r.reason})</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    // Clear form
                    document.getElementById('broadcast-message').value = '';
                } else {
                    resultContent.innerHTML = `<div style="color: #dc3545;">‚ùå <strong>Broadcast Failed:</strong> ${result.error}</div>`;
                }
                
            } catch (error) {
                console.error('Broadcast error:', error);
                resultContent.innerHTML = `<div style="color: #dc3545;">‚ùå <strong>Error:</strong> ${error.message}</div>`;
            }
        }
        
        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/admin/health');
                const data = await response.json();
                
                document.getElementById('cpu-usage').textContent = data.system.cpu_percent + '%';
                document.getElementById('memory-usage').textContent = data.system.memory_mb.toFixed(1) + ' MB';
                document.getElementById('bot-latency').textContent = data.bot.latency_ms + ' ms';
                document.getElementById('db-size').textContent = data.database.size_mb.toFixed(2) + ' MB';
                
                // Format uptime
                const uptimeSeconds = data.system.uptime_seconds;
                const hours = Math.floor(uptimeSeconds / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                const seconds = Math.floor(uptimeSeconds % 60);
                document.getElementById('bot-uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Modules
                const modulesList = document.getElementById('modules-list');
                modulesList.innerHTML = data.modules.loaded.map(module => `
                    <div class="glass-card" style="padding: 1rem; text-align: center;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚úÖ</div>
                        <div style="font-size: 0.875rem; color: var(--text-primary);">${module}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load system health:', error);
            }
        }
        
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/admin/cache');
                const data = await response.json();
                
                document.getElementById('cache-size').textContent = 
                    (data.downloads.size_mb + data.cache.size_mb).toFixed(2) + ' MB';
                    
            } catch (error) {
                console.error('Failed to load cache stats:', error);
            }
        }
        
        async function loadCommandStats() {
            try {
                const response = await fetch('/api/analytics/commands');
                const data = await response.json();
                
                const statsDiv = document.getElementById('command-stats');
                if (data.length === 0) {
                    statsDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No command data yet</div>';
                    return;
                }
                
                statsDiv.innerHTML = data.slice(0, 10).map((cmd, idx) => `
                    <div class="glass-card" style="padding: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--maroon-primary); min-width: 30px;">#${idx + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">/${cmd.command}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Used ${cmd.count} times</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--maroon-primary);">${cmd.count}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load command stats:', error);
            }
        }
        
        async function loadPlatformStats() {
            try {
                const response = await fetch('/api/analytics/platforms');
                const data = await response.json();
                
                const platforms = {
                    'spotify': 0,
                    'youtube': 0,
                    'apple_music': 0
                };
                
                data.forEach(item => {
                    if (item.platform) {
                        platforms[item.platform.toLowerCase()] = item.count;
                    }
                });
                
                document.getElementById('spotify-count').textContent = platforms.spotify || 0;
                document.getElementById('youtube-count').textContent = platforms.youtube || 0;
                document.getElementById('apple-count').textContent = platforms.apple_music || 0;
                
            } catch (error) {
                console.error('Failed to load platform stats:', error);
            }
        }
        
        async function loadPlayMethodStats() {
            try {
                const response = await fetch('/api/analytics/play-methods');
                const data = await response.json();
                
                const methods = {
                    'track': 0,
                    'playlist': 0,
                    'album': 0,
                    'search': 0
                };
                
                data.forEach(item => {
                    if (item.method) {
                        methods[item.method.toLowerCase()] = item.count;
                    }
                });
                
                document.getElementById('single-count').textContent = methods.track || 0;
                document.getElementById('playlist-count').textContent = methods.playlist || 0;
                document.getElementById('album-count').textContent = methods.album || 0;
                document.getElementById('search-count').textContent = methods.search || 0;
                
            } catch (error) {
                console.error('Failed to load play method stats:', error);
            }
        }
        
        async function loadTopTracks() {
            try {
                const response = await fetch('/api/admin/activity?days=30');
                const data = await response.json();
                
                const tracksDiv = document.getElementById('top-tracks');
                if (!data.top_tracks || data.top_tracks.length === 0) {
                    tracksDiv.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No track data yet</div>';
                    return;
                }
                
                tracksDiv.innerHTML = data.top_tracks.slice(0, 10).map((track, idx) => `
                    <div class="glass-card" style="padding: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--maroon-primary); min-width: 30px;">#${idx + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">${track.title}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${track.artist}</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--maroon-primary);">${track.plays} plays</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load top tracks:', error);
            }
        }
        
        async function loadLogs() {
            try {
                const response = await fetch(`/api/admin/logs?type=${currentLogFilter}&lines=50`);
                const data = await response.json();
                
                const logsDiv = document.getElementById('console-logs');
                if (!data.logs || data.logs.length === 0) {
                    logsDiv.innerHTML = '<div style="color: var(--text-secondary);">No logs available</div>';
                    return;
                }
                
                logsDiv.innerHTML = data.logs.map(log => {
                    let color = 'var(--text-secondary)';
                    if (log.level === 'ERROR') color = '#dc3545';
                    else if (log.level === 'WARNING') color = '#ffc107';
                    else if (log.level === 'INFO') color = '#17a2b8';
                    
                    return `<div style="margin-bottom: 0.5rem; color: ${color};">
                        <span style="opacity: 0.7;">[${log.timestamp}]</span>
                        <span style="font-weight: 600;">[${log.level}]</span>
                        <span>${log.message}</span>
                    </div>`;
                }).join('');
                
                // Auto scroll to bottom
                logsDiv.scrollTop = logsDiv.scrollHeight;
                
            } catch (error) {
                console.error('Failed to load logs:', error);
            }
        }
        
        // Load all data on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loader = document.getElementById('page-loader');
                if (loader) loader.style.display = 'none';
            }, 1000);
            
            // Initial load
            loadSystemHealth();
            loadCacheStats();
            loadCommandStats();
            loadPlatformStats();
            loadPlayMethodStats();
            loadTopTracks();
            loadLogs();
            loadServersAndChannels();
            
            // Refresh every 5 seconds
            setInterval(() => {
                loadSystemHealth();
                loadCacheStats();
                loadLogs();
            }, 5000);
            
            // Refresh stats every 30 seconds
            setInterval(() => {
                loadCommandStats();
                loadPlatformStats();
                loadPlayMethodStats();
                loadTopTracks();
            }, 30000);
        });
    </script>
</body>
</html>
